<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apex Viewer</title>
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var version = params.get('version');
      var baseUrl = params.get('baseUrl');
      
      if (!version) {
        var match = window.location.pathname.match(/\/viewer\/([^/]+)\//);
        if (match) version = match[1];
      }
      
      if (!version) {
        console.error('[Viewer Host] No version specified. Use ?version=x.y.z');
        return;
      }

      var basePath = baseUrl 
        ? baseUrl + '/' + version + '/'
        : '/viewer/' + version + '/';

      console.log('[Viewer Host] Loading bundles from:', basePath);

      // Load CSS
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = basePath + 'bundle.css';
      document.head.appendChild(link);

      if (baseUrl) {
        // External URL: fetch bundle as text, load via blob with correct MIME type.
        fetch(basePath + 'bundle.js')
          .then(function(res) {
            if (!res.ok) throw new Error('Failed to fetch bundle.js: ' + res.status);
            return res.text();
          })
          .then(function(code) {
            console.log('[Viewer Host] Bundle fetched, size:', code.length);
            var blob = new Blob([code], { type: 'application/javascript' });
            var blobUrl = URL.createObjectURL(blob);
            var script = document.createElement('script');
            script.type = 'module';
            script.src = blobUrl;
            script.onerror = function(e) {
              console.error('[Viewer Host] Blob script error:', e);
            };
            document.head.appendChild(script);
          })
          .catch(function(err) {
            console.error('[Viewer Host] Failed to load bundle:', err);
          });
      } else {
        var script = document.createElement('script');
        script.type = 'module';
        script.src = basePath + 'bundle.js';
        document.head.appendChild(script);
      }
    })();
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>