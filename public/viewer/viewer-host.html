<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apex Viewer</title>
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);

      // Reset URL path to '/' so the viewer's router matches its root route.
      // Without this, the router sees '/viewer/viewer-host.html' and shows "Not Found".
      history.replaceState(null, '', '/' + window.location.search);

      var version = params.get('version');
      var baseUrl = params.get('baseUrl');

      if (!version) {
        console.error('[Viewer Host] No version specified. Use ?version=x.y.z');
        return;
      }

      if (!baseUrl) {
        console.error('[Viewer Host] No baseUrl specified.');
        return;
      }

      var basePath = baseUrl.replace(/\/+$/, '') + '/' + version + '/';
      console.log('[Viewer Host] Loading bundles from:', basePath);

      // Load CSS
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = basePath + 'bundle.css';
      document.head.appendChild(link);

      // Load JS â€” S3 serves correct MIME types, so load directly as ES module
      var script = document.createElement('script');
      script.type = 'module';
      script.src = basePath + 'bundle.js';
      script.onerror = function(e) {
        console.error('[Viewer Host] Failed to load bundle.js:', e);
      };
      script.onload = function() {
        console.log('[Viewer Host] bundle.js loaded, waiting for render...');
        // Poll for the viewer to render content into #root, then signal ready
        var readyPoll = setInterval(function() {
          var root = document.getElementById('root');
          if (root && root.children.length > 0) {
            clearInterval(readyPoll);
            console.log('[Viewer Host] Viewer rendered, sending ready message');
            window.parent.postMessage({ type: 'apex-viewer-ready' }, '*');
          }
        }, 200);
        // Stop polling after 30s
        setTimeout(function() { clearInterval(readyPoll); }, 30000);
      };
      document.head.appendChild(script);
    })();
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>
